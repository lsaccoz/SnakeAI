<html>

    <head>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

        <style>
            #svgWrapper {
                width: 400px;
                height: 400px;
                background: red;
            }
        </style>
    </head>

    <body>

        <h1>Snake</h1>
        <span id="score"></span>

        <div id="svgWrapper">
            <svg id="svgContainer"></svg>
        </div>

        <script>

            var svg = null;
            var dim = 500;
            var gridDimension = 30;
            var refreshRate = 1000/15; // denominator = number of times per second
            var interval = null;

            window.onload = function() {
                svg = d3.select("#svgContainer");
                setStyle();
                makeGrid();

                $(window).keydown(function(event) {

                    if (37 <= event.keyCode && event.keyCode <= 40) {
                        model.inputQueue.put(event.keyCode);
                    }
                });

                interval = setInterval(tick, refreshRate);
            }

            function setStyle() {
                svg.attr("height", dim);
                svg.attr("width", dim);

                svg.style("background", "#eeeeee");
            }

            function makeGrid() {
                var lines = [...Array(model.gridDimension).keys()].map(i => i*(dim/model.gridDimension));

                var linedata = svg.selectAll("line").data(lines).enter();

                // make horizontal lines
                linedata.append("line")
                    .attr("x1", 0)
                    .attr("y1", d => d)
                    .attr("x2", dim)
                    .attr("y2", d => d)
                    .attr("stroke-width", 1)
                    .attr("stroke", "#888888");

                // make vertical lines
                linedata.append("line")
                    .attr("x1", d => d)
                    .attr("y1", 0)
                    .attr("x2", d => d)
                    .attr("y2", dim)
                    .attr("stroke-width", 1)
                    .attr("stroke", "#888888");
            }

            var model = {
                gridDimension: gridDimension, // 30 x 30 grid
                snake: [...Array(4).keys()].map(i => {return {x:gridDimension/2-i, y:gridDimension/2};}),
                orientation: {x: 1, y: 0}, // right, left, up, down
                food: {x: randBetween(1,gridDimension), y: randBetween(1,gridDimension)},
                inputQueue: function() {
                    var queue = [];
                    return {
                        get: ()  => queue,
                        pop: ()  => {
                            var m = queue.pop();
                            if (!m) return undefined;
                            if (m === 37) return "left";
                            if (m === 38) return "up";
                            if (m === 39) return "right";
                            else          return "down";
                        },
                        put: (e) => queue.splice(0,0,e)
                    };
                }(),
                isGameOver: function() {
                    if (!(1 <= model.snake[0].x && model.snake[0].x <= model.gridDimension && 1 <= model.snake[0].y && model.snake[0].y <= model.gridDimension)) {
                        return true;
                    }
                    if (model.snake.filter(s => s.x === model.snake[0].x && s.y === model.snake[0].y).length > 1) {
                        return true;
                    }
                    return false;
                }
            };

            function tick() {
                var move = model.inputQueue.pop();
                if (move) {
                    if (move === "up" && model.orientation.y !== 1) {
                        model.orientation = {x: 0, y: -1};
                    }
                    else if (move === "down" && model.orientation.y !== -1) {
                        model.orientation = {x: 0, y: 1};
                    }
                    else if (move === "left" && model.orientation.x !== 1) {
                        model.orientation = {x: -1, y: 0};
                    }
                    else if (move === "right" && model.orientation.x !== -1) {
                        model.orientation = {x: 1, y: 0};
                    }
                }

                updateModel();

                drawModel();
            }

            function updateModel() {
                for (var i = model.snake.length-1; i > 0; i--) {
                    model.snake[i].x = model.snake[i-1].x;
                    model.snake[i].y = model.snake[i-1].y;
                }
                model.snake[0].x += model.orientation.x;
                model.snake[0].y += model.orientation.y;

                // check if we got da food
                if (model.snake[0].x === model.food.x && model.snake[0].y === model.food.y) {
                    var last = model.snake[model.snake.length-1];
                    var penlast = model.snake[model.snake.length-2];
                    var dx = penlast.x - last.x;
                    var dy = penlast.y - last.y;
                    var tail = {
                        x: last.x - dx, // dx > 0 ? last.x-1 : dx < 0 ? last.x+1 : last.x,
                        y: last.y - dy  // dy > 0 > last.y-1 : dy < 0 ? last.x+1 : last.x
                    }
                    model.snake.push(tail);
                    model.food = {x: randBetween(1,gridDimension), y: randBetween(1,gridDimension)};
                }

                document.getElementById("score").innerText = "your score is " + model.snake.length;

                // check if lost the game
                if (model.isGameOver()) {
                    clearInterval(interval);
                }
            }

            function drawModel() {
                svg.selectAll("rect").remove();

                var box = dim/model.gridDimension;

                // draw the snake
                svg.selectAll("rect").data(model.snake).enter()
                    .append("rect")
                    .attr("x", d => (d.x-1)*box) // top left
                    .attr("y", d => (d.y-1)*box) // of rect
                    .attr("width", box)
                    .attr("height", box)
                    .style("fill", "steelblue")
                    .style("fill-opacity", 1)
                    .style("stroke", "black")
                    .style("stroke-width", 1.5)
                    .style("stroke-opacity", 0.6);

                // draw the food
                svg.append("rect")
                    .attr("x", (model.food.x-1)*box) // top left
                    .attr("y", (model.food.y-1)*box) // of rect
                    .attr("width", box)
                    .attr("height", box)
                    .style("fill", "salmon")
                    .style("fill-opacity", 1)
                    .style("stroke", "black")
                    .style("stroke-width", 1.5)
                    .style("stroke-opacity", 0.6);
            }

            function randBetween(min, max) {
                return Math.round(Math.random() * (max - min) + min);
            }














        </script>

    </body>

</html>
